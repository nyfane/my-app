pipeline {
    agent any
    tools{
        maven 'M2_HOME'
    }
    environment {
        registry = '823008317281.dkr.ecr.us-west-2.amazonaws.com/myjob'
        dockerimage = ''

    }
    stages {
        stage('Checkout'){
            steps{
                git branch: 'master', url: 'https://github.com/nyfane/my-app.git'
            }
        }
        stage('Code Build') {
            steps {
                sh 'mvn clean package'
            }
        }
        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }
        // Build Docker images
        stage ('build image') {
            steps {
                script {
                    dockerImage = docker.build registry + ":$BUILD_NUMBER"
                }
                
            }
        }
        // Upload Docker images into AWS ECR
        stage ('Upload image to ecr') {
           steps {
            sh 'aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 823008317281.dkr.ecr.us-west-2.amazonaws.com'
            sh 'docker build -t myjob .'
            sh 'docker tag myjob:latest 823008317281.dkr.ecr.us-west-2.amazonaws.com/myjob:latest'
            sh 'docker push 823008317281.dkr.ecr.us-west-2.amazonaws.com/myjob:latest'
           } 
        }
        // Deploy to EKS cluster
        stage ('Deploy to EKS') {
          steps {
            withKubeConfig(caCertificate: 'LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1EY3lPVEF4TURBd05sb1hEVE15TURjeU5qQXhNREF3Tmxvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBS0Z6CnBOUE9JMWVBZjFvaWNnMzhIVTNMMksxeFFXR05UV0h3c3F6eGVPVHpCM1VuaGJqbmJMV1lUYVpIYTJaUHhZV1YKQVdsUUZla2JBeVhjRWtNejJGR2pMNjZYK0x4L2ZwNENmMm5MbFlsNE9uYXpKR0pESzMrUjBEMXJCZDhRY2ZSUgp2ZWEvOFlIV0VUZk13Y1ZzRVBodnpGeEtkRGpIaEdpS0dKai9UUllia2pKelgwNDhuS0tPOE55aUg4SC9hcllQCjNLKzR6bTRuTmtkWDZ6ZllOaWNiQUxud2hKbjFXQlJoQzdZR0NFNmpuakhUNWtVYm9xTFdVQ0lrK0NCb2JBYzgKTzZESTU3aWdjRDNWNzN2bW5mZkUvZ2V1Sm5Vd3htRjhadUJCc1B2YjlzbC9tV2w1MTN4VFc3NnNwL05ZYVJPcApGWEVCVk44YUhwUWZFUEJuWWY4Q0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZFKzVHeWxTZysxSHRUVEZTZWlGdWJKYTFJNW1NQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBRWw3Mlo3YnlZRzlSZ21HM3BEaAo5d0dzUHJxL1hRVDRYOVF2cy9QMDVpWmtWMzlzT3NRTXlnbFVKcWIxL1MwMlJUcEtGK1lSdW5TZmhYS01Sc25KCkRDQ3llMGVLYnU4MnVtc0l0a2lWWnhISCttM0Q5L2UwWUQwNmQvenAyTzVKbm03ZHE5dHA0bm1XL2NreGJaUXYKVVJzSllVeUVrVnlCY1NBaGVUWUZvd3JsU0w1allkOU1wSGFFWnZXa2lxczFOSnZPdHdPMnJWUjFzeUJCYjRBUApmT3NLMEswdDJ2dFhNWG1BR0dEZXRWT3RJUmQ5bDBLZFhaTXp1eHlQeC8zU1FpaHBhRFgwcmkxdFJMRW43eFdoCi9Qa0w3VkptU3ZPV3BzVXRvVEpOek1PWDV0RFZ5dXVRMmx5aVE2d1RVVUUvSUI0b01JZjlKdFZBRkhZVXFNRzgKRFNFPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==', clusterName: 'my-cluster1.us-west-2.eksctl.io ', contextName: 'iam-root-account@my-cluster1.us-west-2.eksctl.io', credentialsId: 'eks_credential', namespace: '', serverUrl: 'https://42457AD70E5913E4D401553883923141.gr7.us-west-2.eks.amazonaws.com ') {
    // some block
            }
          }
        }

    }
}